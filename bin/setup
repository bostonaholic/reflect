#!/bin/bash

set -e
if [ "${DEBUG:-}" = "1" ]; then
  set -x
fi

cd "$(dirname "$0")/.."

bin/bootstrap

echo "==> Setting up environment variables…"

# Skip environment setup in test environment
if [ "$ENV" != "test" ]; then
  # Check if .env file exists; create from example if missing
  if [ ! -f ".env" ]; then
    if [ ! -f ".env.example" ]; then
      echo "Error: .env.example not found."
      exit 1
    fi

    echo "==> No .env file found. Copying from .env.example…"
    cp .env.example .env
    echo "Edit .env with your tokens, then re-run bin/setup."
    exit 0
  fi

  # Check if .env is encrypted (contains encrypted: values)
  if grep -q "encrypted:" .env 2>/dev/null; then
    echo "==> Detected encrypted .env file…"
    if [ ! -f ".env.keys" ]; then
      echo "Error: .env is encrypted but .env.keys not found."
      echo "Either decrypt with: npx dotenvx decrypt"
      echo "Or restore your .env.keys file containing DOTENV_PRIVATE_KEY."
      exit 1
    fi
    # Use dotenvx to decrypt and export variables for validation
    if ! eval "$(npx dotenvx get --format shell)"; then
      echo "Error: Failed to decrypt .env file."
      exit 1
    fi
  else
    # Source the plain .env file
    # shellcheck disable=SC1091
    source .env
  fi

  # Check required environment variables
  required_vars=(
    "GITHUB_TOKEN"
    "OPENAI_API_KEY"
  )

  missing_vars=()

  for var in "${required_vars[@]}"; do
    if [ -z "${!var}" ]; then
      missing_vars+=("$var")
    fi
  done

  if [ ${#missing_vars[@]} -ne 0 ]; then
    echo "Error: The following required environment variables are not set:"
    printf '%s\n' "${missing_vars[@]}"
    echo "Please set these variables in your .env file."
    exit 1
  fi

  # Offer to encrypt .env if it is not already encrypted
  if ! grep -q "encrypted:" .env 2>/dev/null; then
    printf "Would you like to encrypt your .env file with dotenvx? [y/N] "
    read -r encrypt_answer
    if [ "$encrypt_answer" = "y" ] || [ "$encrypt_answer" = "Y" ]; then
      echo "==> Encrypting .env…"
      npx dotenvx encrypt
      echo "==> .env encrypted. Keep .env.keys safe — you need it to decrypt."
    fi
  fi
fi

echo "==> App is now ready to go!"