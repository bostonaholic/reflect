#!/bin/bash

set -e
if [ "${DEBUG:-}" = "1" ]; then
  set -x
fi

cd "$(dirname "$0")/.."

bin/bootstrap

echo "==> Setting up environment variables…"

# Skip environment setup in test environment
if [ "$ENV" != "test" ]; then
  # Check if .env file exists
  if [ ! -f ".env" ]; then
    echo "Error: .env file not found. Please copy .env.example to .env and fill in your values."
    exit 1
  fi

  # Check if .env is encrypted (contains encrypted: values)
  if grep -q "encrypted:" .env 2>/dev/null; then
    echo "==> Detected encrypted .env file…"
    if [ ! -f ".env.keys" ]; then
      echo "Error: .env is encrypted but .env.keys not found."
      echo "Either decrypt with: npx dotenvx decrypt"
      echo "Or restore your .env.keys file containing DOTENV_PRIVATE_KEY."
      exit 1
    fi
    # Use dotenvx to decrypt and export variables for validation
    eval "$(npx dotenvx get --format shell 2>/dev/null)"
  else
    # Source the plain .env file
    # shellcheck disable=SC1091
    source .env
  fi

  # Check required environment variables
  required_vars=(
    "GITHUB_TOKEN"
    "OPENAI_API_KEY"
  )

  missing_vars=()

  for var in "${required_vars[@]}"; do
    if [ -z "${!var}" ]; then
      missing_vars+=("$var")
    fi
  done

  if [ ${#missing_vars[@]} -ne 0 ]; then
    echo "Error: The following required environment variables are not set:"
    printf '%s\n' "${missing_vars[@]}"
    echo "Please set these variables in your .env file."
    exit 1
  fi
fi

echo "==> App is now ready to go!"